; $ID:	CHL_PROFILE_WOZNIAK.PRO,	2020-07-08-15,	USER-KJWH	$
;#####################################################################################
   FUNCTION CHL_PROFILE_WOZNIAK,CHL_SAT,Z_RES=Z_RES, MAX_DEPTH=MAX_DEPTH

;+
; NAME:
;		CHL_PROFILE_WOZNIAK
;
; PURPOSE:
;		THIS FUNCTION GENERATE VERTICAL PROFILES OF CHLOROPHYLL CONCENTRATION FROM SURFACE CHLOROPHYLL CONCENTRATION (WOZNIAK ET AL. 2003)
;
; CATEGORY:
;		MODELS
;
; CALLING SEQUENCE:
;		RESULT = CHL_PROFILE_WOZNIAK(0.7)
;  	RESULT = CHL_PROFILE_WOZNIAK([ 0.015625, 0.03125, 0.0625, 0.125,0.25,0.5,1,2,4,8,16])
;
; INPUTS:
;		CHL_SAT:	SATELLITE (SURFACE) CHLOROPHYLL A CONCENTRATION
;

; KEYWORD PARAMETERS:
;		Z_RES:  RESOLUTION IN METERS (DEFAULT = 0.01)
; 	MAX_DEPTH: THE MAXIMUM DEPTH FOR COMPUTING THE CHLOROPHYLL PROFILE

; OUTPUTS:
;		STRUCTURE WITH THE SAMPLING DEPTHS AND ESTIMATED CHLORPHYLL CONCENTRATION
;
; OPTIONAL OUTPUTS:
;		ERROR:     ANY ERROR MESSAGES ARE PLACED IN ERROR, IF NO ERRORS THEN ERROR = ''
;
;	PROCEDURE:
;			THIS IS USUALLY A DESCRIPTION OF THE METHOD, OR ANY DATA MANIPULATIONS
;
; EXAMPLE:
;
;	NOTES:
;		THIS ROUTINE WILL DISPLAY BETTER IF YOU SET YOUR TAB TO 2 SPACES:
;	  (PREFERENCES, EDITOR, THE TAB NUMBER OF SPACES TO INDENT FOR EACH TAB: 2)
;
;	CITATION:
; 	WOZNIAK,B., J.DERA, D.FICEK, R.MAJCHROWSKI, M.OSTROWSKA, S.KACZMAREK. 2003.
;		MODELLING LIGHT AND PHOTOSYNTHESIS IN THE MARINE ENVIRIONENT. OCEANOLOGIA, 45 [1]:171-245
; 	PAGE 184, EQUATIONS 1-5.
;	EXAMPLE:
; EXAMPLE FROM JERZY DERA (DERA@IOPAN.GDA.PL) APRIL 2, 2007
; CCONST	0.661107408
; CM	0.25983043
; Z_MAX	25.7117557
; SIGMAZ	0.037478045
;	Z	CA(Z)
;	0		0.7
;	1		0.706905689	31	0.8348719		61	0.647327838
;	2		0.714014092	32	0.831178976	62	0.643366173
;	3		0.721298191	33	0.826923864	63	0.639688406
;	4		0.728727582	34	0.822140831	64	0.636286283
;	5		0.736268592	35	0.816867847	65	0.633150169
;	6		0.743884468	36	0.811146083	66	0.63026929
;	7		0.751535607	37	0.805019379	67	0.627631961
;	8		0.759179846	38	0.798533683	68	0.625225813
;	9		0.76677281	39	0.791736484	69	0.623037989
;	10	0.774268302	40	0.784676239	70	0.621055344
;	11	0.781618748	41	0.777401799	71	0.619264608
;	12	0.788775674	42	0.769961865	72	0.617652547
;	13	0.795690227	43	0.762404451	73	0.616206092
;	14	0.802313714	44	0.754776396	74	0.614912462
;	15	0.808598167	45	0.747122896	75	0.613759261
;	16	0.814496915	46	0.739487095	76	0.612734558
;	17	0.819965155	47	0.73190972	77	0.611826955
;	18	0.82496052	48	0.724428764	78	0.611025636
;	19	0.829443622	49	0.717079228	79	0.610320401
;	20	0.833378565	50	0.709892919	80	0.609701693
;	21	0.83673343	51	0.702898301	81	0.609160604
;	22	0.839480699	52	0.696120404	82	0.608688881
;	23	0.841597637	53	0.689580781	83	0.608278917
;	24	0.843066597	54	0.683297521	84	0.607923736
;	25	0.843875276	55	0.677285301	85	0.607616971
;	26	0.844016877	56	0.671555486	86	0.607352844
;	27	0.843490207	57	0.666116263	87	0.607126128
;	28	0.842299697	58	0.660972806	88	0.606932123
;	29	0.840455335	59	0.656127475	89	0.606766619
;	30	0.837972532	60	0.651580024	90	0.606625859

;BELOW I ADD  ALSO THE FULL ALGORITHM OF THE COMPUTATION IN DELPHI:
;
;	CCONST:=POWER(10,((-0.0437)+0.8644*LOGCA0+(-0.0888)*SQR(LOGCA0)));
; CM:=0.269+0.245*LOGCA0+1.51*SQR(LOGCA0)+2.13*SQR(LOGCA0)*LOGCA0
;       +0.81*SQR(LOGCA0)*SQR(LOGCA0);
; Z_MAX:=17.9-44.6*LOGCA0+38.1*SQR(LOGCA0)+1.32*SQR(LOGCA0)*LOGCA0
;        -10.7*SQR(LOGCA0)*SQR(LOGCA0);
;
;	SIGZ:=0.0408+0.0217*LOGCA0+0.00239*SQR(LOGCA0)+0.00562*SQR(LOGCA0)*LOGCA0
;        +0.00514*SQR(LOGCA0)*SQR(LOGCA0);
;    CA[Z]:=CA0*(CCONST+CM*EXP(-SQR((Z*STEPH-Z_MAX)*SIGZ)))
;    /(CCONST+CM*EXP(-SQR(Z_MAX*SIGZ)));
;
;BEST REGARDS
;BOGDAN WOZ'NIAK  AND JERZY DERA
;
; MODIFICATION HISTORY:
;			WRITTEN APRIL 2, 2007 BY J.O'REILLY, 28 TARZWELL DRIVE, NMFS, NOAA 02882 (JAY.O'REILLY@NOAA.GOV)
;			OCT 4,2014,JOR ADDED METHOD TO OUTPUT STRUCTURE
;############################################################################################
;-
;***********************************
ROUTINE_NAME = 'CHL_PROFILE_WOZNIAK'
;***********************************
	ERROR = ''

; ====================>
; CHECK  KEYWORDS  SUPPLIED BY USER AND SET DEFAULT VALUES
  IF N_ELEMENTS(CHL_SAT)  LT 1 THEN BEGIN
  	ERROR='MUST PROVIDE CHL_SAT'
  	RETURN,''
  ENDIF

  IF N_ELEMENTS(MAX_DEPTH) LT 1 THEN _MAX_DEPTH = 200 ELSE _MAX_DEPTH=MAX_DEPTH   ; NUMBER OF EUPHOTIC DEPTHS
  IF N_ELEMENTS(Z_RES)  LT 1 THEN Z_RES  = 0.01 								; DEFAULT VERTICAL RESOLUTION IN EUPHOTIC DEPTH UNITS


; ===> CREATE AN INTEGER VARIABLE (Z) WITH RESOLUTION= Z_RES
  Z=FINDGEN(ROUND(_MAX_DEPTH/Z_RES))*Z_RES

;	===> CSAT IS NOT EXACTLY EQUAL TO SURFACE CHL (CA0) !
	CA0 = CHL_SAT


; *********************************************************************************************
	CCONST = 10^(-0.0437 +0.8644* ALOG10(CA0)  -0.0888*(ALOG10(CA0))^2)

	CM 		= 0.269 	+ 0.245	*(ALOG10(CA0)) + 1.51		*(ALOG10(CA0))^2 + 2.13		*(ALOG10(CA0))^3 + 0.81		*(ALOG10(CA0))^4;

	Z_MAX = 17.9   	- 44.6  *(ALOG10(CA0)) + 38.1		*(ALOG10(CA0))^2 + 1.32		*(ALOG10(CA0))^3 -10.7		*(ALOG10(CA0))^4;

	SZ 		= 0.0408 	+ 0.0217*(ALOG10(CA0)) + 0.00239*(ALOG10(CA0))^2 + 0.00562*(ALOG10(CA0))^3 + 0.00514*(ALOG10(CA0))^4;


;	===> ORIGINAL MODEL: WHEN CHL < 0.0323594 Z_MAX IS 131.592 AT LOWER CHL THE Z_MAX STARTS TO INCREASE
;			 SO, ENSURE THAT Z_MAX IS 132 WHEN CHL < 0.03
	IF CA0 LT 0.033 THEN BEGIN
 		Z_MAX = 132.0
;		CCONST = 10^(-0.0437 +0.8644* ALOG10(0.03)  -0.0888*(ALOG10(0.03))^2)
		CCONST =  0.0271633
	ENDIF

;	===> AVOID ARTIFACTS WHEN CHL IS VERY LOW
	CM = CM > 0.269
	SZ = SZ > 0.0408

;	===> ENSURE Z_MAX IS GE 0
	Z_MAX = Z_MAX > 0

  CHL=  CA0* ((CCONST+CM*EXP(-((Z-Z_MAX)*SZ)^2)) / (CCONST+CM*EXP(-((Z_MAX)*SZ)^2)) )

 	RETURN, CREATE_STRUCT('METHOD','WOZNIAK','Z_MAX',Z_MAX,'Z_RES',Z_RES,'Z',Z,'CHL',CHL, 'ERROR',ERROR)


	END; #####################  END OF ROUTINE ################################
