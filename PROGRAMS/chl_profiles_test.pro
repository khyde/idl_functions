; $ID:	CHL_PROFILES_TEST.PRO,	2020-07-01-12,	USER-KJWH	$

PRO CHL_PROFILES_TEST

;+
; NAME:
;   CHL_PROFILES_TEST
;
; PURPOSE:
;   This is the MAIN procedure to TEST the CHL_PROFILES outputs
;
; CATEGORY:
;   CHL_PROFILES
;
; NOTES:
;
;   SWITCHES governs which processing steps to do and what to do in the step
;     '' (NULL STRING) = do not do the step
;        ANY ONE OR COMBINATION OF LETTERS WILL RUN THE STEP:
;     Y  = YES do the step
;     O  = OVERWRITE any output
;     V  = VERBOSE (allow PRINT statements)
;     RF = REVERSE the processing order of files in the step
;     S  = STOP at the beginning of the step and step through each command in the step
;     DATERANGE = Daterange for selecting files
;
; MODIFICATION HISTORY:
;     Written:  December 29, 2015  by K.J.W. Hyde, 28 Tarzwell Drive, NMFS, NOAA 02882 (kimberly.hyde@noaa.gov)
;     Modified: December 30, 2015 - KJWH: 
;-
; ****************************************************************************************************

  ROUTINE_NAME = 'CHL_PROFILES_TEST'
  
  SL = PATH_SEP()
  DIR = !S.PROJECTS + 'CHL_PROFILES' + SL
  DIR_DATA = DIR + 'DATA' +SL
  DIR_PRO_PNGS = DIR + 'PROFILE_PNGS' + SL
  DIR_TEST, [DIR,DIR_DATA,DIR_PRO_PNGS]

  ;===> #####   SWITCHES
  MASTER_CHL = !S.MASTER + 'CHL_PROFILES-MASTER.SAV'
  DO_PROFILE_ZCODE   = '' & ZCODE_EDIT_FILE = DIR_DATA + 'CHL_PROFILES-ZCODE_EDIT.SAV' ; Remove profiles with 2 or fewer measurements
  DO_PROFILE_SURF    = 'Y' & SCODE_EDIT_FILE = DIR_DATA + 'CHL_PROFILES-ZCODE_SURF_EDIT.SAV' ; Remove profiles where max depth is < 3
  DO_PROFILE_DCODE   = 'Y' & DCODE_EDIT_FILE = DIR_DATA + 'CHL_PROFILES-ZCODE_SURF_DCODE_EDIT.SAV' ; Look at profiles with duplicates


  ;|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||


; **********************************
  IF KEY(DO_PROFILE_ZCODE) THEN BEGIN
; **********************************
    SNAME = 'DO_PROFILE_ZCODE'
    SWITCHES,DO_PROFILE_ZCODE,STOPP=STOPP,OVERWRITE=OVERWRITE,VERBOSE=VERBOSE,INIT=INIT,R_FILES=R_FILES,R_DATASETS=R_DATASETS,R_MAPS=R_MAPS,DATERANGE=DATERANGE
    IF VERBOSE THEN PRINT, 'Running: ' + SNAME
    IF KEY(STOPP) THEN STOP

    CHL = IDL_RESTORE(MASTER_CHL)
    CHL = STRUCT_CLEAN(CHL,EXCLUDE = ['TEMP','CODE','SOURCE'])
    CHL = STRUCT_2NUM(CHL)
    CHL = CHL(WHERE(CHL.CHL GE 0.0))     ; Eliminate negative chlorophyll values (4019 measurements)
    
    PSETS = WHERE_SETS(CHL.PNUM)
    OK = WHERE(PSETS.N GE 3)             ; Need at least 3 measurements to be considered a "profile"  (Only 17080 out of 107366 profiles have 3 or more measurements)
    PSUBS = WHERE_SETS_SUBS(PSETS[OK])
    PCHL = CHL(PSUBS)
    
    ZCHL  = PCHL(WHERE(PCHL.CODE EQ 'Z')) ; Find Z code profiles (n=76)
    ZSET = WHERE_SETS(ZCHL.PNUM)
    PAGE_COUNT = 1
    FOR N=0, N_ELEMENTS(ZSET)-1 DO BEGIN
      ANUM = ZSET(N).VALUE
      ACHL = PCHL(WHERE(PCHL.PNUM EQ ANUM,COUNT))
      ZERO = ACHL(WHERE(ACHL.CHL EQ 0.0))
      IF COUNT LE 1 THEN STOP
      
      BUFFER = 1
      IF N MOD 20 EQ 0 THEN BEGIN
        W = WINDOW(DIMENSIONS=[850,1100],BUFFER=BUFFER)
        COUNTER = 1
        PNGFILE =  DIR_PRO_PNGS + 'Z_CODE_PROFILES-PAGE_' + NUM2STR(PAGE_COUNT) + '.PNG'
      ENDIF
      
      TITLE = NUM2STR(ACHL[0].YEAR) + '_' + NUM2STR(ACHL[0].DOY) 
      PLT = PLOT(FLOAT(ACHL.CHL), -1.0*FLOAT(ACHL.DEPTH), COLOR='PALE_GREEN', SYMBOL='CIRCLE', /SYM_FILLED, SYM_SIZE=0.75, THICK=2, MARGIN=0.1, /CURRENT, LAYOUT=[4,5,COUNTER],CLIP=0, BUFFER=BUFFER, TITLE=TITLE)
      SYM = SYMBOL(FLOAT(ZERO.CHL), -1.0*FLOAT(ZERO.DEPTH), SYM_COLOR='FIREBRICK', SYMBOL='STAR', SYM_SIZE=1.25, /SYM_FILLED, /DATA, TARGET=PLT,CLIP=0)
      
      COUNTER = COUNTER + 1
      IF N MOD 20 EQ 19 OR N EQ N_ELEMENTS(ZSET)-1 THEN BEGIN
        W.SAVE, PNGFILE
        W.CLOSE
        PAGE_COUNT = PAGE_COUNT + 1
      ENDIF
    ENDFOR
    SAVE, FILENAME=ZCODE_EDIT_FILE, ZCHL
  ENDIF ; IF DO_PROFILE_ZCODE GE 1 THEN BEGIN 
    
; **********************************
  IF KEY(DO_PROFILE_SURF) THEN BEGIN
; **********************************
    SNAME = 'DO_PROFILE_SURF'
    SWITCHES,DO_PROFILE_SURF,STOPP=STOPP,OVERWRITE=OVERWRITE,VERBOSE=VERBOSE,INIT=INIT,R_FILES=R_FILES,R_DATASETS=R_DATASETS,R_MAPS=R_MAPS,DATERANGE=DATERANGE
    IF VERBOSE THEN PRINT, 'Running: ' + SNAME
    IF KEY(STOPP) THEN STOP

    CHL = IDL_RESTORE(ZCODE_EDIT_FILE)
    PSETS = WHERE_SETS(CHL.PNUM)
    
    FOR N=0, N_ELEMENTS(PSETS)-1 DO BEGIN
      SUBS = WHERE_SETS_SUBS(PSETS(N))
      PSET = CHL(SUBS)
      ZERO = PSET(WHERE(PSET.CHL EQ 0.0))
      MAXD = MAX(PSET.DEPTH)  
      IF MAXD LT 5.0 THEN BEGIN ; If max depth <5 m, then remove
        CHL(SUBS).CHL = MISSINGS(CHL.CHL)
      ENDIF
      IF COUNT LE 1 THEN STOP

      BUFFER = 1
      IF N MOD 20 EQ 0 THEN BEGIN
        W = WINDOW(DIMENSIONS=[850,1100],BUFFER=BUFFER)
        COUNTER = 1
        PNGFILE =  DIR_PRO_PNGS + 'Z_CODE_PROFILES-PAGE_' + NUM2STR(PAGE_COUNT) + '.PNG'
      ENDIF

      TITLE = NUM2STR(ACHL[0].YEAR) + '_' + NUM2STR(ACHL[0].DOY)
      PLT = PLOT(ACHL.CHL, -1*ACHL.DEPTH, COLOR='PALE_GREEN', SYMBOL='CIRCLE', /SYM_FILLED, SYM_SIZE=0.75, THICK=2, MARGIN=0.1, /CURRENT, LAYOUT=[4,5,COUNTER],CLIP=0, BUFFER=BUFFER, TITLE=TITLE)
      SYM = SYMBOL(ZERO.CHL, -1*ZERO.DEPTH, SYM_COLOR='FIREBRICK', SYMBOL='STAR', SYM_SIZE=1.25, /SYM_FILLED, /DATA, TARGET=PLT,CLIP=0)

      COUNTER = COUNTER + 1
      IF N MOD 20 EQ 19 OR N EQ N_ELEMENTS(ZSET)-1 THEN BEGIN
        W.SAVE, PNGFILE
        W.CLOSE
        PAGE_COUNT = PAGE_COUNT + 1
      ENDIF
    ENDFOR
    
  STOP
    CHL = CHL(WHERE(CHL.CHL NE MISSINGS(CHL.CHL)))  
    SAVE, FILENAME=SURF_EDIT_FILE, ZCHL
  ENDIF ; IF DO_PROFILE_ZCODE GE 1 THEN BEGIN   
    
; **********************************
  IF KEY(DO_PROFILE_DCODE) THEN BEGIN
; **********************************
    SNAME = 'DO_PROFILE_DCODE'
    SWITCHES,DO_PROFILE_DCODE,STOPP=STOPP,OVERWRITE=OVERWRITE,VERBOSE=VERBOSE,INIT=INIT,R_FILES=R_FILES,R_DATASETS=R_DATASETS,R_MAPS=R_MAPS,DATERANGE=DATERANGE
    IF VERBOSE THEN PRINT, 'Running: ' + SNAME
    IF KEY(STOPP) THEN STOP

    CHL = CHL_PROFILES_READ()
    PSETS = WHERE_SETS(CHL.PNUM)
    OK = WHERE(PSETS.N GE 3)             ; Need at least 3 measurements to be considered a "profile"
    PSUBS = WHERE_SETS_SUBS(PSETS[OK])
    PCHL = CHL(PSUBS)
    DCHL  = PCHL(WHERE(PCHL.CODE EQ 'D'))

    DSET = WHERE_SETS(DCHL.PNUM)
    PAGE_COUNT = 1
    FOR N=0, N_ELEMENTS(DSET)-1 DO BEGIN
      ANUM = DSET(N).VALUE
      ACHL = PCHL(WHERE(PCHL.PNUM EQ ANUM,COUNT))
      DUP = ACHL(WHERE(ACHL.CODE EQ 'D'))
      IF COUNT LE 1 THEN STOP

      BUFFER = 1
      IF N MOD 20 EQ 0 THEN BEGIN
        W = WINDOW(DIMENSIONS=[850,1100],BUFFER=BUFFER)
        COUNTER = 1
        PNGFILE =  DIR_PRO_PNGS + 'D_CODE_PROFILES-PAGE_' + NUM2STR(PAGE_COUNT) + '.PNG'
      ENDIF

      TITLE = NUM2STR(ACHL[0].YEAR) + '_' + NUM2STR(ACHL[0].DOY)
      PLT = PLOT(ACHL.CHL, -1*ACHL.DEPTH, COLOR='PALE_GREEN', SYMBOL='CIRCLE', /SYM_FILLED, SYM_SIZE=0.75, THICK=2, MARGIN=0.1, /CURRENT, LAYOUT=[4,5,COUNTER],CLIP=0, BUFFER=BUFFER, TITLE=TITLE)
      SYM = SYMBOL(DUP.CHL, -1*DUP.DEPTH, SYM_COLOR='FIREBRICK', SYMBOL='STAR', SYM_SIZE=1.25, /SYM_FILLED, /DATA, TARGET=PLT,CLIP=0)

      COUNTER = COUNTER + 1
      IF N MOD 20 EQ 19 OR N EQ N_ELEMENTS(ZSET)-1 THEN BEGIN
        W.SAVE, PNGFILE
        W.CLOSE
        PAGE_COUNT = PAGE_COUNT + 1
      ENDIF
    ENDFOR
  ENDIF ; IF DO_PROFILE_DCODE GE 1 THEN BEGIN  
    
    
  STOP  
    
    HELP, WHERE(CHL.CODE EQ 'S')
    HELP, WHERE(CHL.CODE EQ 'Z')
    HELP, WHERE(CHL.CODE EQ 'D')
    HELP, WHERE(CHL.CODE EQ 'SP')
    HELP, WHERE(CHL.CODE EQ '')
    
   STOP
   ; FIND ALL PROFILES WITH A 'Z' CODE AND PLOT THE PROFILES.  QC ANY THAT ARE ALL ZERO'S OR ONES THAT HAVE AN OUTLIER
   
   ; FIND ALL PROFILES THAT ONLY HAVE A SINGLE MEASUREMENT AND REMOVE
   
   ; FIND ALL DUPLICATE PROFILES AND REMOVE THE DUPLICATE
   
   ; FIGURE OUT WHAT THE 'SP' CODE IS 
   

    IF VERBOSE THEN , 'DO_PROFILE_INFO'
 
  



END; #####################  End of Routine ################################
