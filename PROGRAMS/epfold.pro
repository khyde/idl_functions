; $ID:	EPFOLD.PRO,	2020-07-08-15,	USER-KJWH	$
PRO EPFOLD,INTIME,INRATE,RATERR=INERROR,=,PSTOP=PSTOP, $
           NBINS=NBINS,SAMPLING=SAMPL,CHATTY=CHATTY,CHIERG=CHIERG, $
           MAXCHIERG=MAXCHIERG,GTI=GTI ,PERSIG=PERSIG,LINEAR=LINEAR,        $
           TRIAL_PERIOD=TRIAL_PERIOD,FITCHI=FITCHI, TOLERANCE=TOLERANCE
;+
; NAME:
;             EPFOLD
;
;
; PURPOSE:
;
; CATEGORY:
;             TIMING TOOLS
;
;
; CALLING SEQUENCE:
;             EPFOLD,TIME,RATE,RATERR=RATERR,=,PSTOP=PSTOP,
;                    NBINS=NBINS,SAMPLING=SAMPLING,/CHISQ
;
;
; INPUTS:
;             TIME : A VECTOR CONTAINING THE TIME IN ARBITARY UNITS
;             RATE : A VECTOR CONTAINING THE COUNTRATE; IF NOT GIVEN,
;                    THE TIMES ARE ASSUMED TO COME FROM INDIVIDUAL EVENTS
;             :   LOWEST PERIOD TO BE CONSIDERED
;             PSTOP:    HIGHEST PERIOD TO BE CONSIDERED
;
; OPTIONAL INPUTS:
;             GTI: AT THE MOMENT FOR EVENT DATA ONLY: GTI[2,*] IS AN
;                  ARRAY WITH THE GOOD TIMES FROM THE EVENT SELECTION,
;                  GTI[0,*] ARE THE START TIMES, GTI[1,*] THE STOP
;                  TIMES. OBVIOUSLY, USE THE SAME TIME SYSTEM FOR TIME
;                  AND GTI (I.E., ALSO BARYCENTER GTIS!). NEEDED FOR
;                  THE COMPUTATION OF THE EXPOSURE TIME OF THE PHASE
;                  BINS, IF NOT GIVEN, THE TIME OF THE FIRST AND THE
;                  LAST EVENT IS USED INSTEAD.
;             RATERROR: A GIVEN ERROR VECTOR FOR THE COUNTRATE. IF NOT
;                       GIVEN AND WE ARE NOT WORKING ON EVENTS,
;                       RATERROR IS COMPUTED USING POISSONIAN
;                       STATISTICS.
;             NBINS:    NUMBER OF PHASE-BINS TO BE USED IN CREATING THE TRIAL
;                       PULSE (DEFAULT=20)
;             SAMPLING: HOW MANY PERIODS PER PEAK TO USE (DEFAULT=10)
;             LINEAR  : IF SET, USE A LINEAR TRIAL PERIOD ARRAY WITH
;                       STEP EQUAL TO THE VALUE OF LINEAR
;             TRIAL_PERIOD : ARRAY CONTAINS THE TRIAL PERIODS. IF SET,
;                             IS THE SMALLEST TRIAL PERIOD AND
;                            PSTOP THE LONGEST.
;            TOLERANCE: PARAMETER DEFINING THE LOWER LIMIT FOR THE GAP
;                       LENGTH; THE REFERENCE IS THE TIME DIFFERENCE
;                       BETWEEN THE FIRST AND SECOND ENTRY IN THE TIME
;                       ARRAY; TOLERANCE DEFINES THE MAXIMUM ALLOWED RELATIVE
;                       DEVIATION FROM THIS REFERENCE BIN LENGTH;
;                       DEFAULT: 1E-8; THIS PARAMETER IS PASSED TO TIMEGAP
;                       (SEE TIMGAP.PRO FOR FURTHER EXPLANATION)
;
; KEYWORD PARAMETERS:

;             FITCHI   : FIT A GAUSS DISTRIBUTION TO THE CHI^2 AND USE
;                        THE CENTER OF THE GAUSS TO DETERMINE THE
;                        PERIOD, INSTEAD OF USING THE MAXIMUM OF THE
;                        CHI^2 DISTRIBUTION. THIS IS MAINLY NEEDED BY
;                        EPERROR.PRO. IN CASE THIS KEYWORD IS SET
;                        CHIERG WILL BE 3 DIMENSIONAL ARRAY AND THE
;                        FIT RESULT IS STORED IN
;                        CHIERG[2,*]. MAXCHIERG[1] STILL CONTAINS THE
;                        MAXIMUM CHI^2 AND NOT THE CHI^2 OF THE FITTED
;                        PERIOD !!
;             CHATTY   : IF SET, BE CHATTY
;
; OUTPUTS:
;             CHIERG   : 2D-ARRAY, CHIERG[0,*] CONTAINS THE TRIAL
;                        PERIOD, AND CHIERG[1,*] THE RESPECTIVE CHI^2
;                        VALUE.
;
; OPTIONAL OUTPUTS:
;             MAXCHIERG: 2 DIM. ARRAY, MAXCHIERG[0] CONTAINS THE
;                        PERIOD OF MAXIMUM CHI^2, AND MAXCHIERG[1] THE
;                        RESPECTIVE MAXIMUM CHI^2
;             PERSIG   : UNCERTAINTY OF THAT PERIOD, FROM TRIANGULAR
;                        APPROXIMATION, NOT TO BE INTERPRETED IN A
;                        STATISTICAL SENSE!
;
;
; COMMON BLOCKS:
;             NONE
;
;
; SIDE EFFECTS:
;             NONE
;
;
; RESTRICTIONS:
;
;             THE INPUT LIGHTCURVE HAS TO BE GIVEN IN COUNT RATES (NOT
;             IN PHOTON NUMBERS). TO PREVENT CONVERGENCE PROBLEMS OF
;             THE FIT (ONLY IF KEYWORD /FITCHI IS SET), THE MAXIMUM OF
;             THE CHI^2 DISTRIBUTION HAS TO BE IN BETWEEN  AND
;             PSTOP, AND THE PERIOD INTERVAL HAS TO BE RESONABLE
;             LARGE.
;
;
; PROCEDURE:
;             THIS SUBROUTINE PERFORMS A PERIOD SEARCH USING EPOCH
;             FOLDING. FOR EACH TRIAL PERIOD, A PULSE PROFILE IS
;             GENERATED USING PFOLD. THIS PROFILE IS THEN TESTED FOR
;             CONSTANCY USING A CHI^2 TEST. THE MAXIMUM CHI^2,
;             I.E., THE MAXIMUM DEVIATION, IS THE MOST POSSIBLE
;             PERIOD. THIS IS DONE FOR ALL PERIODS BETWEEN  AND
;             PSTOP USING A GRID-SEARCH OPERATING ON THE MINIMUM
;             POSSIBLE PERIOD THAT CAN STILL BE DETECTED (GIVEN BY
;             P^2/T).
;
;             CAVEAT: THE SIGNIFICANCE OF THE FOUND PERIODS SHOULD NOT
;             BE TESTED USING THE CHI^2 VALUE OBTAINED FROM THIS
;             ROUTINE, SINCE THE VALUES ARE ONLY ASYMPTOTICALLY CHI^2
;             DISTRIBUTED (SEE DAVIES, 1990, SCHWARZENBERG-CZERNY,
;             1989, LARSSON, 1996)
;
;             READ (AND UNDERSTAND) THE REFERENCES BEFORE USING THIS
;             ROUTINE!
;
;             REFERENCES:
;                 DAVIES, S.R., 1990, MNRAS 244, 93
;                 LARSSON, S., 1996, A&AS 117, 197
;                 LEAHY, D.A., DARBRO, W., ELSNER, R.F., ET AL., 1983,
;                    APJ 266, 160-170
;                 SCHWARZENBERG-CZERNY, A., 1989, MNRAS 241, 153
;
; EXAMPLE:
;
;
; MODIFICATION HISTORY:
;
; $LOG: EPFOLD.PRO,V $
; REVISION 1.11  2003/07/10 13:57:54  GOEHLER
; FIX: IF RATE IS GIVEN (AS INPUT INRATE) NO GTI DETERMINATION
;      NEEDED. PROBLEM OF ASKING FOR "RATE" VARIABLE EXISTENCE INSTEAD OF
;      INRATE.
; AND: SET START/STOP TIME AS GTI IF NONE GIVEN (+WARNING).
;
; REVISION 1.10  2003/07/02 09:28:06  WILMS
; LJUBA RODINA/JEORN WILMS, IAAT: ADDED SUPPORT FOR EVENT DATA EPOCH FOLDING
;
;
; ----- EARLIER HISTORY --------
;             VERSION 1.0, MICHAEL KOENIG IAAT
;             VERSION 1.1, 1998/04/04, MARKUS KUSTER IAAT
;             VERSION 2.0, 1998/07/01, JEORN WILMS, IAAT
;             VERSION 2.1, 1998/07/20, JEORN WILMS, IAAT
;                NOW USE CLEARER FORMULA FOR CHI^2
;             VERSION 2.2, 1999/08/05, JEORN WILMS, IAAT
;                * MAKE USE OF DT KEYWORD OF NEW PFOLD
;                  (SLIGHT SPEED IMPROVEMENT)
;                * REMOVED SIGNIFICANCE KEYWORD
;                  (CAUSED TOO MUCH TROUBLE)
;             VERSION 2.3, 2000/11/28, SB,
;                  ADD MAXCHIERG OPTIONAL OUTPUT
;             VERSION 2.4, 2001/01/08, SB,
;                  ADD LINEAR OPTIONAL INPUT/KEYWORD
;             VERSION 2.5, 2001/03/07, SB,
;                  ADD TRIAL_PERIOD OPTIONAL INPUT
;             VERSION 2.6, 2001/07/30, MARKUS KUSTER, IAAT
;                  ADD FITCHI KEYWORD
;   --------- SWITCH TO CVS LOGGING ----, SEE ABOVE!
;-

   ;; ******* SET DEFAULT VALUES *********

   TIME=INTIME

   ;; SET DEFAULT VALUE SAMPLING PER PEAK
   IF (N_ELEMENTS(SAMPL) EQ 0) THEN SAMPL =10.

   ;; SET DEFAULT VALUE NUMBER OF BINS
   IF (N_ELEMENTS(NBINS) EQ 0) THEN NBINS=15

   ;; SET DEFAULT TOLERANCE:
   IF (N_ELEMENTS(NBINS) EQ 0) THEN TOLERANCE=1E-8


   DIM=N_ELEMENTS(TIME)

   IF (KEYWORD_SET(CHATTY)) THEN BEGIN
       PRINT,' '
       PRINT,' >> STARTING DATA ANALYSIS <<'
   ENDIF

   ;; ******* DATA ANALYSIS *******
   IF ( N_ELEMENTS(INRATE) EQ 0) THEN BEGIN

       ;; EVENT DATA: NO GTI FILE KNOWN -> WARNING
       IF N_ELEMENTS(GTI) EQ 0 THEN BEGIN
           MESSAGE,'EVENTDATA: GTI NOT KNOWN, USING TIME OF FIRST',/INFORMATIONAL
           MESSAGE,'  AND LAST EVENT. THIS IS MOST PROBABLY NOT',/INFORMATIONAL
           MESSAGE,'  WHAT YOU WANT!',/INFORMATIONAL
           GTI=FLTARR(2,1)
           GTI[0,0]=TIME[0]
           GTI[1,0]=TIME[N_ELEMENTS(TIME)-1]
       ENDIF

       ;; DURATION TIME FOR EVENTS
       TGES=TOTAL(GTI[1,*]-GTI[0,*])
   ENDIF ELSE BEGIN

       RATE=INRATE

       ;; CALCULATE ERROR OR USE GIVEN ERROR-VECTOR
       IF (N_ELEMENTS(INERROR) EQ 0) THEN BEGIN
           ERROR=SQRT(ABS(RATE))
       END ELSE BEGIN
           ERROR=INERROR
       ENDELSE

       TIME = TIME-TIME[0]             ;; SET FIRST BIN = 0 SEC
       MITTEL = TOTAL(RATE)/FLOAT(DIM) ;; CALCULATE MEDIUM VALUE
       RATE = RATE-MITTEL              ;; RENORMALIZE TO MEAN COUNTRATE
       VAR = VARIANCE(RATE)            ;; SAMPLE VARIANCE

       ;; TIME RESOLUTION
       DELTA_T = TEMPORARY(SHIFT(TIME,-1))-TIME
       DELTA_T[N_ELEMENTS(TIME)-1]=DELTA_T[0] ;; SOMEWHAT ARBITRARY
       ;; CALCULATE SMALLEST DELTA_T AND SET IT TO BINTIME
       BINTIME=MIN(DELTA_T)
       ;; MAX. TIMESCALE = PDIM*DTSTEP = TGES
       TGES = TIME[DIM-1]-TIME[0]+ BINTIME ;

   ENDELSE

   IF (KEYWORD_SET(CHATTY)) THEN BEGIN
       IF ( N_ELEMENTS(INRATE) EQ 0) THEN BEGIN
           PRINT,' YOU WORK WITH EVENTS DATA '
           PRINT,' TOTAL OBSERVATION TIME ',TGES

       ENDIF ELSE BEGIN

           RMS = SQRT(TOTAL(RATE^2.)/(DIM-1.))
           PRINT,' MEAN / RMS             ',MITTEL,RMS ; MEDIUM COUNTRATE
           PRINT,' TOTAL OBSERVATION TIME ',TGES
           PRINT,' EFFECTIVE OBSERVATION  ',DIM*BINTIME
           PRINT,' DUTY CYCLE             ',100.*(DIM*BINTIME)/TGES,' %'
           PRINT
       ENDELSE
   ENDIF

   ;; ******* CHI^2-STATISTICS *******

   ;; DETERMINE FINAL DIMENSION OF RESULT
   IF N_ELEMENTS(TRIAL_PERIOD) EQ 0 THEN BEGIN
       ERGDIM=0L
       P = 
       IF N_ELEMENTS(LINEAR) EQ 0 THEN BEGIN
           WHILE (P LE PSTOP) DO BEGIN
               ERGDIM = ERGDIM + 1L
               P=P+P*P/(TGES*SAMPL)
           ENDWHILE
       ENDIF ELSE BEGIN
           ERGDIM = LONG((PSTOP - )/DOUBLE(LINEAR)) +1L
       ENDELSE
   ENDIF ELSE BEGIN
       ;; SORT THE ARRAY IN ASCENDING ORDER
       TRIAL_PERIOD = TRIAL_PERIOD[SORT(TRIAL_PERIOD)]
       ;; DIMENSION OF THE RESULT
       ERGDIM = N_ELEMENTS(TRIAL_PERIOD)
       ;; DETERMINE THE FIRST AND LAST TRIAL PERIOD
        = TRIAL_PERIOD[0]
       PSTOP = TRIAL_PERIOD[ERGDIM-1]
   ENDELSE

   IF (KEYWORD_SET(FITCHI)) THEN BEGIN
       ;; WE NEED A 3 DIMENSIONAL ARRAY TO STORE THE CHI^2 FIT
       CHIERG=DBLARR(3,ERGDIM)
   ENDIF ELSE BEGIN
       CHIERG=DBLARR(2,ERGDIM)
   ENDELSE

   PTEST = 
   I=0L
   WHILE (PTEST LE PSTOP) DO BEGIN
       CHIERG[0,I]=PTEST
       IF ( N_ELEMENTS(INRATE) EQ 0) THEN BEGIN
           ;; WORK WITH EVENTS DATA
           PFOLD, TIME, PROFILE, GTI=GTI,PERIOD=PTEST,NBINS=NBINS, $
             TTOT=TTOT,NPTS=NPTS
           IF (I EQ 0) THEN BEGIN
               MEANRATE=MEAN(PROFILE)
           ENDIF
           CHIERG[1,I]=TOTAL ( (PROFILE-MEANRATE)^2. / (PROFILE/TTOT) )
       ENDIF ELSE BEGIN
           ;; COMPUTE PROFILE FOR TESTPERIOD PTEST. SINCE WE'RE WORKING
           ;; WITH RATES, WE DO NOT HAVE TO TEST FOR GAPS.
           PFOLD,TIME,RATE,PROFILE,PERIOD=PTEST,NBINS=NBINS, $
             PROFERR=PROFERR,RATERR=ERROR,NPTS=NPTS,/NOGAP, $
             DT=DELTA_T,TOLERANCE=TOLERANCE

           ;;JW I'M NOT ENTIRELY SURE WHERE THE EQUATION USED BY MK CAME
           ;;JW FROM. HERE USE EQ. (4) FROM DAVIES.
           ;;JW THAT IS MKS FORMULA
           ;;CHIERG(1,I)=TOTAL(PROFILE^2.)/(NBINS*TOTAL(PROFERR^2.))
           ;;JW AND THIS IS THE DAVIES, EQ.4 / LARSSON, EQ.1
           CHIERG[1,I]=TOTAL(NPTS*PROFILE^2.)/VAR
       ENDELSE
       ;; NEXT TEST PERIOD
       IF N_ELEMENTS(TRIAL_PERIOD) EQ 0 THEN BEGIN
           IF N_ELEMENTS(LINEAR) EQ 0 THEN $
             PTEST = PTEST + PTEST*PTEST/(TGES*SAMPL)
           IF N_ELEMENTS(LINEAR) NE 0 THEN $
             PTEST = PTEST + DOUBLE(LINEAR)
       ENDIF ELSE BEGIN
           IF I+1L LT ERGDIM THEN PTEST = TRIAL_PERIOD[I+1L] $
           ELSE PTEST = PSTOP + 1.
       ENDELSE
       I=I+1L

       ;; CURRENT STATUS
       IF (KEYWORD_SET(CHATTY)) THEN BEGIN
           IF ((I MOD 500) EQ 0) THEN PRINT,I*100./ERGDIM,' % DONE'
       ENDIF
   ENDWHILE

   CHIMEAN=TOTAL(CHIERG[1,*])/ERGDIM
   CHISIG=SQRT(TOTAL((CHIERG[1,*]-CHIMEAN)^2.)/(ERGDIM-1))
   MAXCHI=MAX(CHIERG[1,*],MAXINDEX)

   IF (KEYWORD_SET(FITCHI)) THEN BEGIN
       ;; PERFORM A SIMPLE GAUSS FIT
       CHIFIT=GAUSSFIT(CHIERG(0,*),CHIERG(1,*),F,NTERMS=4)
       ;; SET PERIOD TO THE CENTER OF THE GAUSSIAN
       PERIOD=F[1]
       CHIERG[2,*]=CHIFIT
   ENDIF ELSE BEGIN
       PERIOD=CHIERG[0,MAXINDEX]
   ENDELSE

   MAXCHIERG = [PERIOD,MAXCHI]

   PERSIG=PERIOD^2./TGES
   ;;JW THIS FORMULA IS MOST PROBABLY WRONG
   ;; SIG=(MAXCHI-CHIMEAN)/CHISIG

   IF (KEYWORD_SET(CHATTY)) THEN BEGIN
       PRINT,' MAX. CHISQUARE : ',MAXCHI, ' ( P= ',PERIOD,')'
   ENDIF
END

