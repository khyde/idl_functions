; $ID:	SUBAREAS_MASTER.PRO,	2020-07-08-15,	USER-KJWH	$
;+
;#############################################################################################################
	PRO SUBAREAS_MASTER,OVERWRITE=OVERWRITE

;
; PURPOSE: MAKES THE SUBAREA MASTER DATABASE AS A SAVE FILE
;
; CATEGORY:	SUBAREAS FAMILY
;
; CALLING SEQUENCE: SUBAREAS_MASTER,STRUCT
;
; INPUTS: STRUCTURE [SPREAD SHEET TYPE DATABASE]
;		
; OPTIONAL INPUTS:
;		NONE:	
;		
; KEYWORD PARAMETERS:
;		TAG: THE TAGNAME TO PLOT

; OUTPUTS: 
;		
; EXAMPLES: 
;
; MODIFICATION HISTORY:
;			MAY 30,2014,WRITTEN BY J.O'REILLY & KIM HYDE
;			MAY 31,JOR, ADDED BATS AS A TEST FOR A SINGLE LONLAT 
;			JUN 17,2014,JOR, REMOVED LON, LAT FROM OUTPUT STRUCT [SINCE NOW USING SHP FILES]
;			NOV 22, 2017 - KJWH: Changed PLT_SHP to READ_SHPFILE
;			
;			
;#################################################################################
;-
;********************************
ROUTINE_NAME  = 'SUBAREAS_MASTER'
;********************************
;
;
;SSSSSS SWITCHES   SSSSSSS
DO_ADD_ALL_SHP = 1
DO_REMOVE_DUPS = 0

;===> DEFAULTS
TEMPLATE = !S.MASTER + 'SUBAREAS_TEMPLATE.CSV'
M = CSV_READ(TEMPLATE) & M= STRUCT_2MISSINGS(M)
;MASTER = !S.MASTER + 'SUBAREAS_MASTER.SAV'
;SAV = IDL_RESTORE(MASTER)

;********************************
IF DO_ADD_ALL_SHP GE 1 THEN BEGIN
;********************************
DIR_IN = !S.SUBAREAS + 'SHP\'
FILES = FILE_SEARCH(DIR_IN, '*.SHP') & PL,FILES
;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FOR NTH = 0,N_ELEMENTS(FILES)-1 DO BEGIN
  FILE = FILES[NTH]
  PFILE,FILE,/R
  FN = FILE_PARSE(FILE)
  D=M  
  D.SOURCE = FN.FULLNAME
  TXT = STR_SEP(FN.NAME,'-')
  REGION = FIRST(TXT)
  SUBAREA = LAST(TXT)
  D.SUBAREA =STRTRIM(STRUPCASE(SUBAREA),2)
  D.REGION = STRTRIM(STRUPCASE(REGION),2)

  D.METHOD = STRTRIM(STRUPCASE(FN.EXT),2)
  D.AUTHOR = "J O'REILLY"
  D.PERIOD = STRTRIM(DATE_2PERIOD(DATE_NOW()),2)
  ;===> GET LON,LAT FROM SHPFILE
  MAPS_SET,'GEQ' ; SO NO  CONSTRAINTS ON LATLON
  READ_SHPFILE, FILE,COLOR=COLOR,FILL=1,THICK=THICK,VERBOSE=0,$
    GET_RANGE=GET_RANGE,TAGNAME='SUBAREA',VALUE=SUBAREA,$
    RANGE_LON = RANGE_LON, RANGE_LAT = RANGE_LAT,NORMAL=NORMAL,$
    DO_ALL = DO_ALL,AUTO=AUTO,LONS=LONS,LATS=LATS,_EXTRA=_EXTRA
    D.NPTS = ROUNDS(N_ELEMENTS(LONS))
    D.LATMIN = RANGE_LAT[0]
    D.LONMIN = RANGE_LON[0]
    D.LATMAX = RANGE_LAT[1]
    D.LONMAX = RANGE_LON[1]

    IF NONE(SAV) THEN SAV = D ELSE SAV = [SAV,D]
    ST,D
    P
ENDFOR;FOR NTH = 0,N_ELEMENTS(FILES)-1 DO BEGIN
;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF

SAVE,FILENAME = MASTER,SAV,/VERBOSE & PFILE,MASTER
SAVE_2CSV,MASTER
ENDIF;IF DO_ADD_ALL_SHP GE 1 THEN BEGIN
;|||||||||||||||||||||||||||||||||||||



;********************************
IF DO_REMOVE_DUPS GE 1 THEN BEGIN
;********************************
  SAV = IDL_RESTORE(MASTER)
P
  TXT = SAV.REGION + ';' + SAV.SUBAREA + ';' + SAV.SOURCE + ';' + SAV.METHOD + ';' 
  DUPS = WHERE_DUPS(TXT)
  IF N_ELEMENTS(DUPS) GE 1 THEN BEGIN    
  ENDIF;IF N_ELEMENTS(DUPS) GE 1 THEN BEGIN  
ENDIF;IF DO_REMOVE_DUPS GE 1 THEN BEGIN
;||||||||||||||||||||||||||||||||||||||
P



END; #####################  END OF ROUTINE ################################
