; $ID:	CDOM_MANNINO_SAVE_MAKE.PRO,	2020-06-30-17,	USER-KJWH	$
;
;		PURPOSE:
;			Make a standard SAVE file for CDOM computed by A_CDOM_MANNINO algorithm
 ; HISTORY:
;		July 10, 2006	Written by:	J.E. O'Reilly, NOAA, 28 Tarzwell Drive, Narragansett, RI 02882
;
; *************************************************************************

PRO CDOM_MANNINO_SAVE_MAKE,DIR_IN=DIR_IN,DIR_OUT=DIR_OUT,PERIOD_CODE=PERIOD_CODE,OVERWRITE=OVERWRITE
  ROUTINE_NAME='CDOM_MANNINO_SAVE_MAKE'
  CDOM_PRODUCT = 'CDOM_MANNINO'

	IF N_ELEMENTS(PERIOD_CODE) NE 1 THEN _PERIOD_CODE ='!S' ELSE _PERIOD_CODE=PERIOD_CODE

	IF N_ELEMENTS(DIR_IN) LT 1 THEN STOP

	FA_510= FILE_ALL(DIR_IN+_PERIOD_CODE+'_*-nlw_510.save')
	FA_555= FILE_ALL(DIR_IN+_PERIOD_CODE+'_*-nlw_555.save')

	IF N_ELEMENTS(DIR_OUT) LT 1 THEN DIR_OUT=FA_555[0].DIR

	IF FA_510[0].FULLNAME EQ '' OR FA_555[0].FULLNAME EQ '' THEN BEGIN
		PRINT, 'NEED NLW_510 AND  NLW_555 SAVE FILES TO MAKE CDOM_MANNINO'
		GOTO,DONE
	ENDIF

	S=SORT(FA_510.DATE_START) & FA_510=FA_510(S)
	S=SORT(FA_555.DATE_START) & FA_555=FA_555(S)

	IF FA_555[0].FULLNAME EQ '' THEN BEGIN
		PRINT,'NO NLW_555 SAVE FILES FOUND'
		GOTO,DONE
	ENDIF

	S=SORT(FA_555.DATE_START) & FA_555=FA_555(S)

  FOR _FILES = 0L,N_ELEMENTS(FA_555)-1L DO BEGIN
  	AFILE_555=FA_555(_FILES).FULLNAME
  	adate = FA_555(_files).date_start
    PERIOD_TXT=FA_555(_files).PERIOD

		SAVEFILE = FA_555(_FILES).FIRST_NAME
		SAVEFILE = REPLACE(SAVEFILE,'NLW_555',CDOM_PRODUCT)
		SAVEFILE = REPLACE(SAVEFILE,'nLw_555',CDOM_PRODUCT)

		SAVEFILE=DIR_OUT+SAVEFILE+'.save'
		FA_SAVE=FILE_INFO(SAVEFILE)
		exist=FILE_TEST(savefile)
    IF EXIST EQ 1 AND NOT KEYWORD_SET(OVERWRITE) THEN CONTINUE


;   =====> Get Matching 510 for this day
    ok_510 = WHERE(FA_510.date_start EQ adate,COUNT)
    IF COUNT NE 1 THEN CONTINUE
    AFILE_510 = FA_510(ok_510).fullname

    DATA_555 = STRUCT_SD_READ(AFILE_555,prod='NLW_555',STRUCT=STRUCT,COUNT=count_good,SUBS=OK_GOOD,ERROR=error)
 		MASK=STRUCT.MASK
 		CODE_MASK=STRUCT.CODE_MASK
 		CODE_NAME_MASK=STRUCT.CODE_NAME_MASK

 		DATA_510	=	STRUCT_SD_READ(AFILE_510,prod='NLW_510',STRUCT=STRUCT,COUNT=count_good,SUBS=OK_GOOD,ERROR=error)
   	DATA_555 	= STRUCT_SD_READ(AFILE_555,prod='NLW_555',STRUCT=STRUCT,COUNT=count_good,SUBS=OK_GOOD,ERROR=error)

		MISSING		=	MISSINGS(DATA_510)

 		CDOM = A_CDOM_MANNINO_SEAWIFLS(RRS510=DATA_510, RRS555=DATA_555, /LWN  )

STOP

		CDOM=SD_SCALES(CDOM,PROD='CDOM',/DATA2INT,SCALING=SCALING,SLOPE=SLOPE,INTERCEPT=INTERCEPT)

STOP
    MISSING_CODES=MISSINGS(CDOM)
		TRANSFORMATION='ALOG10'
   	DATA_UNITS=UNITS('CDOM')
		DATA_510=''
		DATA_555=''
		DATA_555=''
		STRUCT=''
    STRUCT_SD_WRITE,SAVEFILE,PROD=CDOM_PRODUCT, $
                IMAGE=CDOM,    		MISSING_CODE=missing_codes, $
                MASK=MASK, CODE_MASK=CODE_MASK,    CODE_NAME_MASK=CODE_NAME_MASK, $
                SCALING=SCALING,  INTERCEPT=INTERCEPT,    SLOPE=SLOPE,       DATA_UNITS=DATA_UNITS,$
                TRANSFORMATION=TRANSFORMATION,$
                PERIOD=FA_555(_FILES).PERIOD, $
         ;      PERIOD=PERIOD,    SENSOR=SENSOR,        SATELLITE=SATELLITE, SAT_EXTRA=SAT_EXTRA,$
         ;      METHOD=METHOD,    SUITE=SUITE,          MAP=MAP, $
                INFILE=AFILE,$
         ;      NOTES=NOTES,      STATUS=STATUS)
                NOTES='',      ERROR=ERROR
   ENDFOR
   DONE:
END; #####################  End of Routine ################################
