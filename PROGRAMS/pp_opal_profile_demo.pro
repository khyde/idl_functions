; $ID:	PP_OPAL_PROFILE_DEMO.PRO,	2020-07-08-15,	USER-KJWH	$

	PRO PP_OPAL_PROFILE_DEMO

;+
; NAME:
;		MARMAP_OPAL_MAIN
;
; PURPOSE:;
;		This procedure is the MAIN program for analyzing MARMAP data with the OPAL model
;
; CATEGORY:
;		CATEGORY
;
; CALLING SEQUENCE:
;		NO KEYWORDS
;
; INPUTS:
;
; OPTIONAL INPUTS:
;
; KEYWORD PARAMETERS:
;
;	NOTES:
;
;
; MODIFICATION HISTORY:
;			Written Nov, 2010 by K.J.W.Hyde, 28 Tarzwell Drive, NMFS, NOAA 02882 (kimberly.hyde@noaa.gov)
;-
;	****************************************************************************************************
	ROUTINE_NAME = 'PP_OPAL_PROFILE_DEMO'

  DO_SINGLE_EXAMPLE = 1 ; Generates a single plot using a sample MARMAP profile as input
  DO_ALL_MARMAP     = 0 ; Reads the entire MARMAP dataset and creates a series of plots 

	DIR_MARMAP  = FIX_PATH(!S.PROJECTS + 'MARMAP_OPAL\') 
	DIR_PLOTS   = FIX_PATH(DIR_MARMAP + 'PLOTS\')
	DIR_SAVE    = FIX_PATH(DIR_MARMAP + 'SAVE\')
	DIR_TEST, [DIR_PLOTS,DIR_SAVE] 
	
; ************************************
  IF DO_SINGLE_EXAMPLE EQ 1 THEN BEGIN 
; ************************************    
  
    CRUISE = 'AL7812'
    STATION = '6'
    DATE = '197809211140'
    LAT = 38.7667
    LON = -73.50
    DAY_LENGTH = I_SUN_KIRK_DAY_LENGTH(LAT,DATE_2DOY(DATE)) ; ==> Calculate the DAY LENGTH for input into the VGPM models      
    LIGHT_DEPTH = [0.0,     3.0,     8.1,     15.1,    25.1,    33.5,    42.5]
    LIGHT_VALUE = [39.1900, 27.0411, 18.0274, 9.79750, 3.91900, 1.17570, 0.391900]
    LIGHT_PER   = [1.0,     0.69,    0.46,    0.25,    0.10,    0.03,    0.01]
    CHL_DEPTH   = [1.0,   3.0,  8.0,   15.0,  25.0,  34.0,  43.0,  50.0,  60.0,  70.0]
    CHL_VALUE   = [0.102, 0.10, 0.073, 0.087, 0.221, 0.759, 0.296, 0.318, 0.282, 0.090]
    TEMP_DEPTH  = [1.0,  22.0, 25.0, 40.0, 68.0]
    TEMP_VALUE  = [20.0, 20.0, 18.0, 8.0,  7.7]    
    PPD_DEPTH   = [0.0, 3.0,  8.1,  15.1, 25.1, 33.5, 42.5]
    PPD_DATA    = [7.66,10.42,14.96,12.47,15.03,15.28,1.71]
    SST         = TEMP_VALUE[WHERE(TEMP_DEPTH EQ MIN(TEMP_DEPTH))]
    SCHL        = CHL_VALUE[WHERE(CHL_DEPTH EQ MIN(CHL_DEPTH))]
    SPAR        = LIGHT_VALUE[WHERE(LIGHT_DEPTH EQ MIN(LIGHT_DEPTH))]
    BOTTOM_DEPTH = 70.0
    EUPHOTIC_DEPTH = 42.5
    DAILY_PAR   = 39.19
    INTEGRATED_PP = 529
    ZRES = 0.01
    
    MAX_DEPTH = MAX([LIGHT_DEPTH,CHL_DEPTH,TEMP_DEPTH,PPD_DEPTH]) ; For input into PP_OPAL_PROFILE
            
  ; ***** Calculate integrated PP from the PP models *****                      
    VGPM      = PP_VGPM(  CHL_SAT=SCHL,SST=SST,PAR=SPAR,DAY_LENGTH=DAY_LENGTH,CHLOR_EUPHOTIC=VGPM_CHLOR_EU)
    VGPM2     = PP_VGPM2( CHL_SAT=SCHL,SST=SST,PAR=SPAR,DAY_LENGTH=DAY_LENGTH,CHLOR_EUPHOTIC=VGPM2_CHLOR_EU)    
    VGPM2A    = PP_VGPM2A(CHL_SAT=SCHL,SST=SST,PAR=SPAR,DAY_LENGTH=DAY_LENGTH,CHLOR_EUPHOTIC=VGPM2A_CHLOR_EU,BOTTOM_DEPTH= BOTTOM_DEPTH)  
    OPAL_PROF = PP_OPAL_PROFILE(CHL_VALUE=CHL_VALUE,CHL_DEPTH=CHL_DEPTH,DAILY_PAR=DAILY_PAR,LIGHT_VALUE=LIGHT_VALUE,LIGHT_DEPTH=LIGHT_DEPTH,SST=SST,SCHL=SCHL,EUPHOTIC_DEPTH=EUPHOTIC_DEPTH,MAX_DEPTH=MAX_DEPTH,ZRES=ZRES,ERROR=ERROR)
    OPAL_PT   = PP_OPAL(CHL=SCHL,SST=SST,PAR=SPAR,Kx=OPAL_PROF.KX[1],USER_Z_RES=ZRES,STRUCT=OPAL)  
    
    MAX_DEPTH = MAX([LIGHT_DEPTH,CHL_DEPTH,TEMP_DEPTH,PPD_DEPTH,EUPHOTIC_DEPTH,OPAL.ZEU,OPAL.Z]) ; For YRANGE   
            
  ; ***** Generate plots *****       
    TICKLEN = 0.02
    TEMP_POS  = [60,55,360,355]
    PAR_POS = [400,55,700,355]
    CHL_POS  = [740,55,1040,355]
    PPD_POS  = [1080,55,1380,355]
    TITLE = 'MARMAP Cruise ' + CRUISE + ' - Station ' + STATION + ' ' + DATE_2YEAR(DATE) + '-' + DATE_2MONTH(DATE) + '-' + DATE_2DAY(DATE)
    YTITLE  = 'Depth (m)'  
    PAR_TITLE  = UNITS('PAR')
    TEMP_TITLE = UNITS('TEMP')
    CHL_TITLE = UNITS('CHLA')
    PPD_TITLE = UNITS('PRIMARY_PRODUCTION')
    YRANGE = NICE_RANGE([-1*MAX_DEPTH-5,0])
    TRANGE = [5,25]
    MCOLOR = 'ORANGE_RED'
    OCOLOR = 'DARK_BLUE'
    PCOLOR = 'MEDIUM_SEA_GREEN'
    TCOLOR = 'BLUE'   
    VCOLOR = ''
    V2COLOR = ''
    V2ACOLOR = ''
    SYM_SIZE = 3.0
    W = WINDOW(DIMENSIONS=[1400,400],BUFFER=BUFFER)
    TI = TEXT(700,370,TITLE,ALIGNMENT=0.5,FONT_SIZE=14,FONT_STYLE='BOLD',/DEVICE)
    
    PROF_TEMP = INTERP_XTEND(TEMP_DEPTH,TEMP_VALUE,OPAL_PROF.DEPTH)
    T   = PLOT(PROF_TEMP.Y,-1*PROF_TEMP.X,POSITION=TEMP_POS,XRANGE=XRANGE,YRANGE=YRANGE,YTITLE=YTITLE,XTITLE=TEMP_TITLE,COLOR=TCOLOR,THICK=3,XTICKLEN=TICKLEN,YTICKLEN=TICKLEN,/CURRENT,/DEVICE)
    TD  = PLOT(TEMP_VALUE,-1*TEMP_DEPTH,LINESTYLE=6,SYMBOL='STAR',SYM_COLOR=TCOLOR,SYM_SIZE=SYM_SIZE,/SYM_FILLED,/OVERPLOT,CLIP=0)
    
    L   = PLOT(OPAL_PROF.PAR,-1*OPAL_PROF.DEPTH,POSITION=PAR_POS,YRANGE=YRANGE,YTITLE='',XTITLE=PAR_TITLE,COLOR=MCOLOR,THICK=3,XTICKLEN=TICKLEN,YTICKLEN=TICKLEN,/CURRENT,/DEVICE)  
    LD  = PLOT(LIGHT_VALUE,-1*LIGHT_DEPTH,LINESTYLE=6,SYMBOL='STAR',SYM_COLOR=MCOLOR,SYM_SIZE=SYM_SIZE,/SYM_FILLED,/OVERPLOT,CLIP=0)
    EU  = PLOT(L.XRANGE,-1*[EUPHOTIC_DEPTH,EUPHOTIC_DEPTH],LINESTYLE=2,COLOR=MCOLOR,THICK=3,/OVERPLOT)
    EUT = TEXT(MAX(L.XRANGE)*0.97,-0.99*EUPHOTIC_DEPTH,'Measured Euphotic Depth',COLOR=MCOLOR,ALIGNMENT=1,/DATA,FONT_STYLE='BOLD',TARGET=L)
    LO  = PLOT(OPAL.PROFILE_PAR,-1*OPAL.Z,YRANGE=YRANGE,COLOR=OCOLOR,THICK=3,/OVERPLOT)  
    EO  = PLOT(L.XRANGE,-1*[OPAL.ZEU,OPAL.ZEU],LINESTYLE=2,COLOR=OCOLOR,THICK=3,/OVERPLOT)
    EOT = TEXT(MAX(L.XRANGE)*0.97,-0.99*OPAL.ZEU,'OPAL Modeled Euphotic Depth',ALIGNMENT=1,/DATA,COLOR=OCOLOR,FONT_STYLE='BOLD',TARGET=L)
      
    C   = PLOT(OPAL_PROF.CHL,-1*OPAL_PROF.DEPTH,POSITION=CHL_POS,YRANGE=YRANGE,YTITLE='',XTITLE=CHL_TITLE,COLOR=MCOLOR,THICK=3,XTICKLEN=TICKLEN,YTICKLEN=TICKLEN,/CURRENT,/DEVICE)  
    CD  = PLOT(CHL_VALUE,-1*CHL_DEPTH,LINESTYLE=6,SYMBOL='STAR',SYM_COLOR=MCOLOR,SYM_SIZE=SYM_SIZE,/SYM_FILLED,/OVERPLOT,CLIP=0)
    CT  = TEXT(0.74,0.2,'Measured $Chl_E_U$= '+NUM2STR(OPAL_PROF.CHL_EUPH,DECIMALS=2),COLOR=MCOLOR,ALIGNMENT=1,/NORMAL,FONT_STYLE='BOLD',TARGET=C)
    CO  = PLOT(OPAL.PROFILE_CHL,-1*OPAL.Z,COLOR=OCOLOR,THICK=3,/OVERPLOT)
    COT = TEXT(0.74,0.15,'OPAL Modeled $Chl_E_U$ = '+NUM2STR(OPAL.CHLOR_EUPHOTIC,DECIMALS=2),ALIGNMENT=1,/NORMAL,COLOR=OCOLOR,FONT_STYLE='BOLD',TARGET=C)
  
    PROF_PPD = INTERP_XTEND(PPD_DEPTH,PPD_DATA,OPAL_PROF.DEPTH)
    P = PLOT(PROF_PPD.Y,-1*PROF_PPD.X,POSITION=PPD_POS,XRANGE=XRANGE,YRANGE=YRANGE,YTITLE='',XTITLE=PPD_TITLE,COLOR=MCOLOR,THICK=3,XTICKLEN=TICKLEN,YTICKLEN=TICKLEN,/CURRENT,/DEVICE)
    PD = PLOT(PPD_DATA,-1*PPD_DEPTH,LINESTYLE=6,SYMBOL='STAR',SYM_COLOR=MCOLOR,SYM_SIZE=SYM_SIZE,/SYM_FILLED,/OVERPLOT,CLIP=0)
    OP = PLOT(OPAL_PROF.OPAL_PP*1000,-1*OPAL_PROF.DEPTH,COLOR=PCOLOR,THICK=3,/OVERPLOT)
    O  = PLOT(OPAL.PROFILE_PP*1000,  -1*OPAL.Z,     COLOR=OCOLOR,THICK=3,/OVERPLOT)
    
    TT = TEXT(0.98,0.45,'Integrated Production',                                                      ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
    TP = TEXT(0.98,0.40,'MARMAP - '       + NUM2STR(INTEGRATED_PP,           DECIMALS=2),COLOR=MCOLOR,ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
    TO = TEXT(0.98,0.35,'OPAL Profile - ' + NUM2STR(OPAL_PROF[0].OPAL_INT_PP,DECIMALS=2),COLOR=PCOLOR,ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
    TO = TEXT(0.98,0.30,'OPAL Modeled - ' + NUM2STR(OPAL[0].PPD*1000,        DECIMALS=2),COLOR=OCOLOR,ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
    TV = TEXT(0.98,0.25,'VGPM - '         + NUM2STR(VGPM*1000,               DECIMALS=2),             ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
    T2 = TEXT(0.98,0.20,'VGPM2 - '        + NUM2STR(VGPM2*1000,              DECIMALS=2),             ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
    TA = TEXT(0.98,0.15,'VGPM2A - '       + NUM2STR(VGPM2A*1000,             DECIMALS=2),             ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
    
    STOP  
    W.CLOSE
  ENDIF ; DO_SINGLE_EXAMPLE
  

; ************************************
  IF DO_ALL_MARMAP EQ 1 THEN BEGIN
; ************************************
    OVERWRITE = DO_ALL_MARMAP GE 2

    BUFFER = 1
    MARMAP_FILE = DIR_SAVE + 'MARMAP-SIZE_FRACTION-CHL_PPD-SURFACE.SAVE'
    MARMAP_DATA = IDL_RESTORE(MARMAP_FILE)
    MARMAP_DATA = MARMAP_DATA[WHERE(MARMAP_DATA.PP_TOTAL NE MISSINGS(MARMAP_DATA.PP_TOTAL) AND MARMAP_DATA.PROFILE_CHL NE MISSINGS(MARMAP_DATA.PROFILE_CHL) AND MARMAP_DATA.SST NE MISSINGS(MARMAP_DATA.SST))]
    
    FOR N=0, N_ELEMENTS(MARMAP_DATA)-1 DO BEGIN      
      MAR     = MARMAP_DATA(N)
      IF MAR.INT_PP_TOTAL EQ MISSINGS(MAR.INT_PP_TOTAL) THEN CONTINUE           
      CRUISE  = MAR.CRUISE
      STATION = MAR.STATION
      DATE    = MAR.DATE
      LAT     = MAR.LAT
      LON     = MAR.LON
      DAY_LENGTH = I_SUN_KIRK_DAY_LENGTH(LAT,DATE_2DOY(DATE))
      
      PNGFILE = DIR_PLOTS + CRUISE+'-STA_'+STATION+'-'+DATE+'-MARMAP_OPAL_DEMO_PLOTS.PNG'
      IF FILE_MAKE([MARMAP_FILE,!S.PROGRAMS+'pp_opal_profile.pro'],PNGFILE,OVERWRITE=OVERWRITE) EQ 0 THEN CONTINUE
    
      SPAR   = FLOAT(MAR.DAILY_EINSTEINS)      
      EUPHOTIC_DEPTH    = MAR.EUPHOTIC_DEPTH
      KD     = -ALOG(0.01)/MAR.EUPHOTIC_DEPTH
      Z90    = 1.0/KD
      IZ90   = EXP(-1)*SPAR
      KD_Z90 = -(ALOG(IZ90/SPAR))/Z90
      
      BOTTOM_DEPTH  = MAR.BOTTOM_DEPTH
      SCHL          = MAR.SURF_CHL
      SST           = MAR.SST
      INTEGRATED_PP = MAR.INT_PP_TOTAL
      
      LIGHT_DEPTH = FLOAT(STRSPLIT(MAR.LIGHT_DEPTH,        ';',/EXTRACT))
      LIGHT_VALUE = FLOAT(STRSPLIT(MAR.LIGHT_VALUE,        ';',/EXTRACT)) & OK = WHERE(LIGHT_VALUE NE 0.0,COUNT) & IF COUNT EQ 0 THEN CONTINUE      
      CHL_DEPTH   = FLOAT(STRSPLIT(MAR.PROFILE_CDEPTH,     ';',/EXTRACT))
      CHL_VALUE   = FLOAT(STRSPLIT(MAR.PROFILE_CHL,        ';',/EXTRACT))
      TEMP_DEPTH  = FLOAT(STRSPLIT(MAR.PROFILE_HYDRO_DEPTH,';',/EXTRACT))
      TEMP_VALUE  = FLOAT(STRSPLIT(MAR.PROFILE_TEMP,       ';',/EXTRACT)) & IF MAR.PROFILE_TEMP EQ '' THEN BEGIN & TEMP_VALUE = SST & TEMP_DEPTH = 0.0 & ENDIF     
      PPD_DEPTH   = FLOAT(STRSPLIT(MAR.PP_DEPTH,           ';',/EXTRACT))
      PPD_VALUE   = FLOAT(STRSPLIT(MAR.PP_TOTAL,           ';',/EXTRACT))
            
      ; ***** Find where there are duplicate Light Depths for deep Light Values *****
      IF LIGHT_DEPTH(-1) EQ LIGHT_DEPTH(-2) THEN BEGIN
        LIGHT_DEPTH = LIGHT_DEPTH(0:-2)
        LIGHT_VALUE = LIGHT_VALUE(0:-2)        
      ENDIF
    
      MAX_DEPTH = MAX([LIGHT_DEPTH,CHL_DEPTH,PPD_DEPTH] < 200) ; For input into PP_OPAL_PROFILE
    
      ; ***** Calculate integrated PP from the PP models *****
      VGPM      = PP_VGPM(  CHL_SAT=SCHL,SST=SST,PAR=SPAR,DAY_LENGTH=DAY_LENGTH,CHLOR_EUPHOTIC=VGPM_CHLOR_EU)
      VGPM2     = PP_VGPM2( CHL_SAT=SCHL,SST=SST,PAR=SPAR,DAY_LENGTH=DAY_LENGTH,CHLOR_EUPHOTIC=VGPM2_CHLOR_EU)
      VGPM2A    = PP_VGPM2A(CHL_SAT=SCHL,SST=SST,PAR=SPAR,DAY_LENGTH=DAY_LENGTH,CHLOR_EUPHOTIC=VGPM2A_CHLOR_EU,BOTTOM_DEPTH= BOTTOM_DEPTH)
      OPAL_PROF = PP_OPAL_PROFILE(CHL_VALUE=CHL_VALUE,CHL_DEPTH=CHL_DEPTH,DAILY_PAR=SPAR,LIGHT_VALUE=LIGHT_VALUE,LIGHT_DEPTH=LIGHT_DEPTH,SST=SST,SCHL=SCHL,EUPHOTIC_DEPTH=EUPHOTIC_DEPTH,MAX_DEPTH=MAX_DEPTH,ERROR=ERROR)
      IF OPAL_PROF.KX[1] LT 0 THEN KX = 0.0 ELSE KX = OPAL_PROF.KX[1]
      OPAL_PT   = PP_OPAL(CHL=SCHL,SST=SST,PAR=SPAR,KX=KX,STRUCT=OPAL)
      
      MAX_DEPTH = MAX([LIGHT_DEPTH,CHL_DEPTH,TEMP_DEPTH,PPD_DEPTH,EUPHOTIC_DEPTH,OPAL.ZEU,OPAL.Z]) ; For YRANGE
      ; ***** Generate plots *****
      
      TICKLEN = 0.02
      TEMP_POS  = [60,55,360,355]
      PAR_POS = [400,55,700,355]
      CHL_POS  = [740,55,1040,355]
      PPD_POS  = [1080,55,1380,355]
      TITLE = 'MARMAP Cruise ' + CRUISE + ' - Station ' + STATION + ' ' + DATE_2YEAR(DATE) + '-' + DATE_2MONTH(DATE) + '-' + DATE_2DAY(DATE)
      YTITLE  = 'Depth (m)'
      PAR_TITLE  = UNITS('PAR')
      TEMP_TITLE = UNITS('TEMP')
      CHL_TITLE = UNITS('CHLA')
      PPD_TITLE = UNITS('PRIMARY_PRODUCTION')
      YRANGE = NICE_RANGE([-1*MAX_DEPTH-5,0])
      TRANGE = [5,25]
      MCOLOR = 'ORANGE_RED'
      OCOLOR = 'DARK_BLUE'
      PCOLOR = 'MEDIUM_SEA_GREEN'
      TCOLOR = 'BLUE'
      VCOLOR = ''
      V2COLOR = ''
      V2ACOLOR = ''
      SYM_SIZE = 3.0
      W = WINDOW(DIMENSIONS=[1400,400],BUFFER=BUFFER)
      TI = TEXT(700,370,TITLE,ALIGNMENT=0.5,FONT_SIZE=14,FONT_STYLE='BOLD',/DEVICE)
      
      PROF_TEMP = INTERP_XTEND(TEMP_DEPTH,TEMP_VALUE,OPAL_PROF.DEPTH)
      T   = PLOT(PROF_TEMP.Y,-1*PROF_TEMP.X,POSITION=TEMP_POS,XRANGE=NICE_RANGE(MINMAX(PROF_TEMP.Y)),YRANGE=YRANGE,YTITLE=YTITLE,XTITLE=TEMP_TITLE,COLOR=TCOLOR,THICK=3,XTICKLEN=TICKLEN,YTICKLEN=TICKLEN,/CURRENT,/DEVICE)
      IF N_ELEMENTS(TEMP_VALUE) GT 1 THEN TD  = PLOT(TEMP_VALUE,-1*TEMP_DEPTH,LINESTYLE=6,SYMBOL='STAR',SYM_COLOR=TCOLOR,SYM_SIZE=SYM_SIZE,/SYM_FILLED,/OVERPLOT,CLIP=0)
      
      L   = PLOT(OPAL_PROF.PAR,-1*OPAL_PROF.DEPTH,POSITION=PAR_POS,YRANGE=YRANGE,YTITLE='',XTITLE=PAR_TITLE,COLOR=MCOLOR,THICK=3,XTICKLEN=TICKLEN,YTICKLEN=TICKLEN,/CURRENT,/DEVICE)
      LD  = PLOT(LIGHT_VALUE,-1*LIGHT_DEPTH,LINESTYLE=6,SYMBOL='STAR',SYM_COLOR=MCOLOR,SYM_SIZE=SYM_SIZE,/SYM_FILLED,/OVERPLOT,CLIP=0)
      EU  = PLOT(L.XRANGE,-1*[EUPHOTIC_DEPTH,EUPHOTIC_DEPTH],LINESTYLE=2,COLOR=MCOLOR,THICK=3,/OVERPLOT)
      EUT = TEXT(MAX(L.XRANGE)*0.97,-0.99*EUPHOTIC_DEPTH,'Measured Euphotic Depth',COLOR=MCOLOR,ALIGNMENT=1,/DATA,FONT_STYLE='BOLD',TARGET=L)
      LO  = PLOT(OPAL.PROFILE_PAR,-1*OPAL.Z,YRANGE=YRANGE,COLOR=OCOLOR,THICK=3,/OVERPLOT)
      EO  = PLOT(L.XRANGE,-1*[OPAL.ZEU,OPAL.ZEU],LINESTYLE=2,COLOR=OCOLOR,THICK=3,/OVERPLOT)
      EOT = TEXT(MAX(L.XRANGE)*0.97,-0.99*OPAL.ZEU,'OPAL Modeled Euphotic Depth',ALIGNMENT=1,/DATA,COLOR=OCOLOR,FONT_STYLE='BOLD',TARGET=L)
      
      C   = PLOT(OPAL_PROF.CHL,-1*OPAL_PROF.DEPTH,POSITION=CHL_POS,YRANGE=YRANGE,YTITLE='',XTITLE=CHL_TITLE,COLOR=MCOLOR,THICK=3,XTICKLEN=TICKLEN,YTICKLEN=TICKLEN,/CURRENT,/DEVICE)
      CD  = PLOT(CHL_VALUE,-1*CHL_DEPTH,LINESTYLE=6,SYMBOL='STAR',SYM_COLOR=MCOLOR,SYM_SIZE=SYM_SIZE,/SYM_FILLED,/OVERPLOT,CLIP=0)
      CT  = TEXT(0.74,0.20,'Measured $Chl_E_U$= '+NUM2STR(OPAL_PROF.CHL_EUPH,DECIMALS=2),COLOR=MCOLOR,ALIGNMENT=1,/NORMAL,FONT_STYLE='BOLD',TARGET=C)
      CO  = PLOT(OPAL.PROFILE_CHL,-1*OPAL.Z,COLOR=OCOLOR,THICK=3,/OVERPLOT)
      COT = TEXT(0.74,0.15,'OPAL Modeled $Chl_E_U$ = '+NUM2STR(OPAL.CHLOR_EUPHOTIC,DECIMALS=2),ALIGNMENT=1,/NORMAL,COLOR=OCOLOR,FONT_STYLE='BOLD',TARGET=C)
      
      PROF_PPD = INTERP_XTEND(PPD_DEPTH,PPD_VALUE,OPAL_PROF.DEPTH)
      P = PLOT(PROF_PPD.Y,-1*PROF_PPD.X,POSITION=PPD_POS,XRANGE=XRANGE,YRANGE=YRANGE,YTITLE='',XTITLE=PPD_TITLE,COLOR=MCOLOR,THICK=3,XTICKLEN=TICKLEN,YTICKLEN=TICKLEN,/CURRENT,/DEVICE)
      PD = PLOT(PPD_VALUE,-1*PPD_DEPTH,LINESTYLE=6,SYMBOL='STAR',SYM_COLOR=MCOLOR,SYM_SIZE=SYM_SIZE,/SYM_FILLED,/OVERPLOT,CLIP=0)
      OP = PLOT(OPAL_PROF.OPAL_PP*1000,-1*OPAL_PROF.DEPTH,COLOR=PCOLOR,THICK=3,/OVERPLOT)
      O  = PLOT(OPAL.PROFILE_PP*1000,  -1*OPAL.Z,     COLOR=OCOLOR,THICK=3,/OVERPLOT)
      
      TT = TEXT(0.98,0.45,'Integrated Production',                                                      ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
      TP = TEXT(0.98,0.40,'MARMAP - '       + NUM2STR(INTEGRATED_PP,           DECIMALS=2),COLOR=MCOLOR,ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
      TO = TEXT(0.98,0.35,'OPAL Profile - ' + NUM2STR(OPAL_PROF[0].OPAL_INT_PP,DECIMALS=2),COLOR=PCOLOR,ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
      TO = TEXT(0.98,0.30,'OPAL Modeled - ' + NUM2STR(OPAL[0].PPD*1000,        DECIMALS=2),COLOR=OCOLOR,ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
      TV = TEXT(0.98,0.25,'VGPM - '         + NUM2STR(VGPM*1000,               DECIMALS=2),             ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
      T2 = TEXT(0.98,0.20,'VGPM2 - '        + NUM2STR(VGPM2*1000,              DECIMALS=2),             ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
      TA = TEXT(0.98,0.15,'VGPM2A - '       + NUM2STR(VGPM2A*1000,             DECIMALS=2),             ALIGNMENT=1,FONT_STYLE='BOLD',/NORMAL,TARGET=P)
      W.SAVE, PNGFILE, RESOLUTION=200
      W.CLOSE
    ENDFOR    
    STOP
  ENDIF

END; #####################  End of Routine ################################



